<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UniSports - CRUD de Turmas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .navbar-custom {
            background-color: #0000CD !important;
        }
        .navbar-custom .navbar-brand,
        .navbar-custom .nav-link,
        .navbar-custom .dropdown-item {
            color: white !important;
        }
        .navbar-custom .dropdown-item:hover {
            background-color: #1e1eff;
            color: white !important;
        }
        .navbar-custom .dropdown-menu {
            background-color: #0000CD;
            border: none;
        }
        /* Card container */
        #classCardsContainer {
            margin-top: 3rem;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .card {
            width: 300px; /* Largura fixa para o card */
            margin-bottom: 15px;
        }
        @media (max-width: 991.98px) { /* Para telas menores que md */
            .card {
                width: calc(50% - 15px); /* 2 cards por linha */
            }
        }
        @media (max-width: 767.98px) { /* Para telas menores que sm */
            .card {
                width: 100%; /* 1 card por linha */
            }
        }
        .card-img-top {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }
        .form-control-sm {
            width: 200px; /* Tamanho reduzido para a caixa de busca */
        }
        .btn-search {
            margin-right: 15px; /* Espaço adicional entre o botão de busca e o de menu */
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">UniSports</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link active" href="#">Home</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">Turmas</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#createModal">Criar Turma</a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editModal">Alterar Turmas</a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#listModal">Ver Turmas</a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#deleteModal">Excluir Turmas</a></li>
                    </ul>
                </li>
            </ul>

            <form class="d-flex" role="search">
                <input class="form-control form-control-sm me-2" type="search" placeholder="Buscar">
                <button class="btn btn-light border-0 btn-search" type="submit"><i class="bi bi-search"></i></button>
            </form>

            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-list"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">Editar Perfil</a></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#viewProfileModal">Perfil</a></li>
                    <li><a class="dropdown-item" href="telasIniciais.html" onclick="alert('Você saiu!')">Sair</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row" id="classCardsContainer"></div>
</div>

<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Criar Turma</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <select id="newClassType" class="form-select">
                <option value="">Selecione o tipo de turma</option>
                <option value="Futebol">Futebol</option>
                <option value="Basquete">Basquete</option>
            </select>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="createClass()">Criar</button>
        </div>
    </div></div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Alterar Turma</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <select id="editClassSelect" class="form-select mb-2"></select>
            <input type="text" id="editClassName" class="form-control" placeholder="Novo nome da turma">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" onclick="editClass()">Salvar</button>
        </div>
    </div></div>
</div>

<div class="modal fade" id="listModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Turmas Cadastradas</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <ul id="classList" class="list-group"></ul>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
    </div></div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Excluir Turma</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <select id="deleteClassSelect" class="form-select"></select>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-danger" onclick="deleteClass()">Excluir</button>
        </div>
    </div></div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">Editar Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="profileImage" class="form-label">Foto de Perfil</label>
                    <img id="profileImagePreview" src="https://via.placeholder.com/150" class="img-fluid rounded-circle mb-3" style="width: 150px; height: 150px;">
                    <input type="file" class="form-control" id="profileImage">
                </div>
                <div class="mb-3">
                    <label for="profileName" class="form-label">Nome</label>
                    <input type="text" class="form-control" id="profileName" value="Nome da Pessoa">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="updateProfile()">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewProfileModal" tabindex="-1" aria-labelledby="viewProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewProfileModalLabel">Perfil do Treinador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 text-center">
                    <img id="viewProfileImage" src="https://via.placeholder.com/150" class="img-fluid rounded-circle" style="width: 150px; height: 150px;">
                </div>
                <div class="mb-3">
                    <label for="viewProfileName" class="form-label">Nome:</label>
                    <input type="text" class="form-control-plaintext" id="viewProfileName" value="Nome da Pessoa" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Turmas:</label>
                    <p id="viewProfileClassCount">Total de turmas: 0</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Variáveis globais para o perfil do treinador
    let trainerName = "Nome da Pessoa";
    let trainerImage = "https://via.placeholder.com/150";
    let currentUserId = ""; // Adicionamos esta variável para armazenar o ID do usuário logado

    // Ao carregar a página, verificamos se há um usuário logado
    document.addEventListener('DOMContentLoaded', function() {
        // Recupera os dados do usuário do sessionStorage
        const userData = sessionStorage.getItem('userData');
        if (userData) {
            const user = JSON.parse(userData);
            currentUserId = user._id;
            trainerName = user.name;
            document.getElementById('viewProfileName').value = trainerName;
        }
        
        // Carregar as turmas do usuário
        loadUserTurmas();
    });

    // Função para exibir a pré-visualização da imagem de perfil no modal de edição
    document.getElementById('profileImage').addEventListener('change', function(event) {
        const reader = new FileReader();
        reader.onload = function() {
            document.getElementById('profileImagePreview').src = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
    });

    // Função para salvar as alterações do perfil
    function updateProfile() {
        const nameInput = document.getElementById('profileName');
        const imageInput = document.getElementById('profileImage');

        trainerName = nameInput.value;
        if (imageInput.files && imageInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function() {
                trainerImage = reader.result;
                document.getElementById('profileImagePreview').src = trainerImage;
                document.getElementById('viewProfileImage').src = trainerImage; // Atualiza no modal de visualização também
            };
            reader.readAsDataURL(imageInput.files[0]);
        } else {
            document.getElementById('profileImagePreview').src = trainerImage;
            document.getElementById('viewProfileImage').src = trainerImage; // Mantém a imagem atual no modal de visualização
        }

        document.getElementById('viewProfileName').value = trainerName;

        alert(`Perfil atualizado com sucesso!\nNome: ${trainerName}`);
        const modal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
        modal.hide();
    }

    // Função para exibir o perfil do treinador
    const viewProfileModalElement = document.getElementById('viewProfileModal');
    viewProfileModalElement.addEventListener('show.bs.modal', function (event) {
        document.getElementById('viewProfileName').value = trainerName;
        document.getElementById('viewProfileImage').src = trainerImage;
        // Atualizar contagem de turmas
        const turmasCount = document.querySelectorAll('#classCardsContainer .card').length;
        document.getElementById('viewProfileClassCount').textContent = `Total de turmas: ${turmasCount}`;
    });

    // Função para gerar um número de turma aleatório (letra + 3 números)
    function generateClassNumber() {
        const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // Letra maiúscula aleatória
        const numbers = Math.floor(Math.random() * 900 + 100); // Número aleatório entre 100 e 999
        return letter + "-" + numbers; // Concatenar como string
    }

    // Função para criar uma nova turma
async function createClass() {
    const newClassType = document.getElementById('newClassType').value;
    const userEmail = localStorage.getItem('userEmail');

    // Validações iniciais reforçadas
    if (!newClassType || newClassType.trim() === '') {
        showAlert('Por favor, selecione um tipo de turma válido.', 'warning');
        return;
    }

    if (!userEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(userEmail)) {
        showAlert('Sessão inválida. Faça login novamente.', 'error');
        clearUserSession();
        return;
    }

    try {
        const classNumber = generateClassNumber();
        const payload = {
            name: newClassType.trim(),
            type: newClassType.trim(),
            number: classNumber,
            createdBy: userEmail
        };

        // Mostra indicador de carregamento
        const submitBtn = document.querySelector('#createModal .modal-footer button[type="button"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Criando...';

        const response = await fetch('http://localhost:3001/api/turmas', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
            },
            body: JSON.stringify(payload)
        });

        // Processamento de resposta melhorado
        const responseData = await processResponse(response);

        if (!response.ok) {
            throw new Error(responseData.message || `Erro ${response.status}: ${response.statusText}`);
        }

        // Atualização otimizada da interface
        await Promise.all([
            createClassCard(responseData),
            updateClassSelectOptions(),
            updateClassListModal()
        ]);

        // Feedback visual de sucesso
        showAlert('Turma criada com sucesso!', 'success');
        
        // Fecha o modal de forma limpa
        const modal = bootstrap.Modal.getInstance(document.getElementById('createModal'));
        if (modal) {
            modal.hide();
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('newClassType').value = '';
            }, { once: true });
        }

    } catch (error) {
        console.error('Erro detalhado:', error);
        showAlert(`Falha ao criar turma: ${error.message}`, 'error');
    } finally {
        // Restaura o botão
        const submitBtn = document.querySelector('#createModal .modal-footer button[type="button"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Criar Turma';
        }
    }
}

// Funções auxiliares adicionais
async function processResponse(response) {
    const contentType = response.headers.get('content-type');
    
    if (contentType && contentType.includes('application/json')) {
        return await response.json();
    }
    
    return { message: await response.text() };
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.getElementById('alerts-container') || document.body;
    container.prepend(alertDiv);
    
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 5000);
}

function clearUserSession() {
    localStorage.removeItem('userEmail');
    localStorage.removeItem('token');
    window.location.href = '/login.html';
}
    // Função para criar o card da turma
    function createClassCard(turma) {
        const card = document.createElement('div');
        card.className = 'card mb-4 shadow-sm bg-white rounded';
        card.style.width = '300px';
        card.dataset.classId = turma._id;

        // Criar a imagem do card
        const image = document.createElement('img');
        image.className = 'card-img-top';
        image.alt = `${turma.name} - ${turma.number}`;
        image.style.height = '150px';
        image.style.objectFit = 'cover';
        
        if (turma.type === 'Futebol') {
            image.src = 'https://www.appai.org.br/wp-content/uploads/2022/07/01-revista-appai-educar-dia-nacional-do-futebol-141.jpg';
        } else if (turma.type === 'Basquete') {
            image.src = 'https://www.cnnbrasil.com.br/wp-content/uploads/sites/12/2024/07/Pre_Olimpico_de-_Basquete-Masculino_Brasil_vence_Filipinas_vai_a_final_e_fica_a_um_jogo_de_Paris-e1720273472112.jpg?w=886';
        } else {
            image.src = 'https://via.placeholder.com/150/0000FF/FFFFFF?Text=' + turma.type;
        }

        // Criar o corpo do card
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body d-flex flex-column justify-content-between';

        // Criar o título do card
        const title = document.createElement('h5');
        title.className = 'card-title';
        title.textContent = `${turma.name} - ${turma.number}`;

        // Criar o texto do card
        const text = document.createElement('p');
        text.className = 'card-text';
        text.textContent = turma.period || '2025.1';

        // Criar o link do card
        const link = document.createElement('a');
        if (turma.type === 'Futebol') {
            link.href = '../Tela-Turmas/Quadra_Futebol.html';
        } else if (turma.type === 'Basquete') {
            link.href = '../Tela-Turmas/Quadra-Basquete.html';
        }
        link.className = 'btn btn-primary mt-2';
        link.textContent = 'Ver Detalhes';

        // Adicionar os elementos ao card
        cardBody.appendChild(title);
        cardBody.appendChild(text);
        cardBody.appendChild(link);
        card.appendChild(image);
        card.appendChild(cardBody);

        // Adicionar o card ao container
        document.getElementById('classCardsContainer').appendChild(card);
    }

    // Função para carregar as turmas do usuário ao abrir a página
    async function loadUserTurmas() {
        if (!currentUserId) return;

        try {
            const response = await fetch(`/api/users/${currentUserId}/turmas`);
            if (!response.ok) {
                throw new Error('Erro ao carregar turmas');
            }

            const turmas = await response.json();
            
            // Limpar o container antes de adicionar as novas turmas
            const container = document.getElementById('classCardsContainer');
            container.innerHTML = '';
            
            // Adicionar cada turma como um card
            turmas.forEach(turma => {
                createClassCard(turma);
            });

        } catch (error) {
            console.error('Erro ao carregar turmas:', error);
        }
    }

    // Função para atualizar as opções do select nos modais de editar e excluir
    async function updateClassSelectOptions() {
        if (!currentUserId) return;

        try {
            const response = await fetch(`/api/users/${currentUserId}/turmas`);
            if (!response.ok) {
                throw new Error('Erro ao carregar turmas');
            }

            const turmas = await response.json();
            
            const editClassSelect = document.getElementById('editClassSelect');
            const deleteClassSelect = document.getElementById('deleteClassSelect');

            // Limpar as opções existentes
            editClassSelect.innerHTML = '<option value="">Selecione uma turma</option>';
            deleteClassSelect.innerHTML = '<option value="">Selecione uma turma</option>';

            // Adicionar as novas opções
            turmas.forEach(turma => {
                const optionEdit = document.createElement('option');
                optionEdit.value = turma._id;
                optionEdit.textContent = turma.name + " - " + turma.number;
                editClassSelect.appendChild(optionEdit);

                const optionDelete = document.createElement('option');
                optionDelete.value = turma._id;
                optionDelete.textContent = turma.name + " - " + turma.number;
                deleteClassSelect.appendChild(optionDelete);
            });

        } catch (error) {
            console.error('Erro ao carregar turmas:', error);
        }
    }

    // Função para popular a lista de turmas no modal de listar
    async function updateClassListModal() {
        if (!currentUserId) return;

        try {
            const response = await fetch(`/api/users/${currentUserId}/turmas`);
            if (!response.ok) {
                throw new Error('Erro ao carregar turmas');
            }

            const turmas = await response.json();
            const classList = document.getElementById('classList');
            classList.innerHTML = ''; // Limpar a lista

            turmas.forEach(turma => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.textContent = turma.name + " - " + turma.number;
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary rounded-pill';
                badge.textContent = turma.type;
                listItem.appendChild(badge);
                classList.appendChild(listItem);
            });

        } catch (error) {
            console.error('Erro ao carregar turmas:', error);
        }
    }

    // Função para editar uma turma existente
    async function editClass() {
        const editClassSelect = document.getElementById('editClassSelect');
        const editClassNameInput = document.getElementById('editClassName');
        const selectedClassId = editClassSelect.value;
        const newClassName = editClassNameInput.value;

        if (!selectedClassId || !newClassName) {
            alert('Por favor, selecione uma turma e digite um novo nome.');
            return;
        }

        try {
            const response = await fetch(`/api/turmas/${selectedClassId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: newClassName })
            });

            if (!response.ok) {
                throw new Error('Erro ao editar turma');
            }

            const updatedTurma = await response.json();

            // Atualizar o card correspondente
            const cardToUpdate = document.querySelector(`.card[data-class-id="${selectedClassId}"]`);
            if (cardToUpdate) {
                const title = cardToUpdate.querySelector('.card-title');
                title.textContent = `${newClassName} - ${updatedTurma.number}`;
            }

            // Fechar o modal de edição
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            editModal.hide();
            editClassNameInput.value = '';

            // Atualizar as opções dos selects
            updateClassSelectOptions();
            updateClassListModal();

        } catch (error) {
            console.error('Erro ao editar turma:', error);
            alert('Erro ao editar turma: ' + error.message);
        }
    }

    // Função para excluir uma turma
    async function deleteClass() {
        const deleteClassSelect = document.getElementById('deleteClassSelect');
        const selectedClassId = deleteClassSelect.value;

        if (!selectedClassId) {
            alert('Por favor, selecione uma turma para excluir.');
            return;
        }

        if (!confirm('Tem certeza que deseja excluir esta turma?')) {
            return;
        }

        try {
            const response = await fetch(`/api/turmas/${selectedClassId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Erro ao excluir turma');
            }

            // Remover o card correspondente
            const cardToRemove = document.querySelector(`.card[data-class-id="${selectedClassId}"]`);
            if (cardToRemove) {
                cardToRemove.remove();
            }

            // Fechar o modal de exclusão
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            deleteModal.hide();

            // Atualizar as opções dos selects
            updateClassSelectOptions();
            updateClassListModal();

        } catch (error) {
            console.error('Erro ao excluir turma:', error);
            alert('Erro ao excluir turma: ' + error.message);
        }
    }
</script>

</body>
</html>